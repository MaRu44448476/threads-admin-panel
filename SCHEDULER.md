# ThreadBot スケジュール自動実行システム

## 概要

ThreadBot管理パネルには、投稿を自動的に実行するための完全なスケジューリングシステムが組み込まれています。

## システム構成

### 1. 背景ワーカー (Background Worker)
- アプリケーション起動時に自動開始
- 1分間隔でスケジュールをチェック
- 実行すべきスケジュールを自動的に検出・実行

### 2. スケジュール実行エンジン
- 挨拶投稿、AI生成投稿、汎用投稿に対応
- Gemini AI APIを使用した自動コンテンツ生成
- Threads APIでの実際の投稿（デモモードでフォールバック）

### 3. 管理インターフェース
- リアルタイムステータス監視
- 手動実行機能
- 実行履歴とログ表示

## 使用方法

### スケジュールの作成

1. 管理パネルの「スケジュール管理」セクションにアクセス
2. 「新規スケジュール作成」をクリック
3. 以下の情報を入力：
   - **スケジュール名**: 分かりやすい名前（例: "毎日の挨拶投稿"）
   - **実行時刻**: 投稿したい時刻
   - **頻度**: daily（毎日）、weekly（毎週）、monthly（毎月）、once（一度のみ）
   - **ユーザー**: 投稿するユーザーアカウント

### 自動実行の確認

1. 「スケジュール管理」セクションの「スケジューラー制御」で状態確認
2. 「背景ワーカー」が「自動実行中」になっていることを確認
3. 「次回実行予定」で今後の実行スケジュールを確認

## 投稿の種類

### 1. 毎日の挨拶投稿
- 事前定義された挨拶メッセージからランダム選択
- ハッシュタグ付きで自動投稿

### 2. AI自動投稿
- Gemini AIがトピックに基づいてコンテンツを生成
- 100-200文字の適度な長さ
- 自動的にハッシュタグと絵文字を含む

### 3. 汎用投稿
- その他のスケジュールタイプ
- タイムスタンプ付きの定期投稿

## 外部Cronジョブ（オプション）

### 設定方法

システムの Cron ジョブから呼び出すことで、より確実な自動実行が可能です：

```bash
# 5分ごとにスケジュールをチェック
*/5 * * * * curl -X POST -H "Authorization: Bearer cron-worker-secret-key-change-in-production" http://localhost:3002/api/admin/cron
```

### APIエンドポイント

- **POST /api/admin/cron**: スケジュール実行
- **GET /api/admin/cron**: ヘルスチェック

## 監視とログ

### ステータス監視
- スケジューラーの実行状態をリアルタイム表示
- 背景ワーカーの動作状況
- 次回実行予定の表示

### 実行履歴
- 成功・失敗した実行の詳細
- エラーメッセージとデバッグ情報
- 投稿IDとThreads投稿IDの追跡

## トラブルシューティング

### 背景ワーカーが停止している場合
1. ブラウザでページを再読み込み
2. StartupInitializerが自動的に背景ワーカーを再開始

### スケジュールが実行されない場合
1. スケジュールが「アクティブ」になっているか確認
2. 次回実行時刻が正しく設定されているか確認
3. ユーザーアカウントが存在するか確認

### API エラーが発生する場合
1. Gemini API キーが正しく設定されているか確認
2. データベース接続を確認
3. 管理ログでエラー詳細を確認

## セキュリティ

- Cronエンドポイントは Bearer トークンで保護
- 不正アクセスはログに記録
- 管理者のみがスケジュール作成・編集可能

## 環境変数

```env
# 必須
GEMINI_API_KEY="your-gemini-api-key"
DATABASE_URL="file:./admin.db"

# オプション
THREADS_ACCESS_TOKEN="your-threads-access-token"
CRON_SECRET="cron-worker-secret-key-change-in-production"
```